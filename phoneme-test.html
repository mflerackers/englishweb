<html>
<header>
    <link href="https://fonts.googleapis.com/css?family=Kalam" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5GH49MRQND"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-5GH49MRQND');
    </script>
    <link rel="stylesheet" type="text/css" href="./colors.css">
    <link rel="stylesheet" type="text/css" href="./svg-colors.css">
    <style>
        .ae {
            fill:url("#ae");
        }
        .aw {
            fill:url("#aw");
        }
        .eh {
            fill:url("#eh");
        }
        .ih {
            fill:url("#ih");
        }
        .iy {
            fill:url("#iy");
        }
        .ow {
            fill:url("#ow");
        }
        .oy {
            fill:url("#oy");
        }
        .uh {
            fill:url("#uh");
        }
        .uw {
            fill:url("#uw");
        }
        .kw {
            fill:url("#kw");
        }
        .sh {
            fill:url("#sh");
        }
        .zh {
            fill:url("#zh");
        }
        body {
            width: 100%;
            background: #f17563;
            color: #222;
            margin: 0px;
        }
        label {
            font-family: Open Sans;
            font-size: 50px;
            -webkit-perspective: 1000px;
            perspective: 1000px;
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
            display: inline-block;
            width: 20vw;
            height: 30vw;
            cursor: pointer;
            margin:1vw;
        }

        @media (min-aspect-ratio: 1/1) {
            label {
                width: 20vh;
                height: 30vh;
            }
        }
        
        .card {
            display:inline-block;
            position: relative;
            height: 25vw;
            width: 25vw;
            background: #fff;
            text-align: center;
            border-radius: 8px;
            background: #222;
            color: #fff;
        }

        .card .back svg {
            padding: 35% 10%;
            width: 80%;
        }
    </style>
</header>
<body>
    <div><a href="./index.html">Text input</a></div>
    <div><a href="./phoneme-test.html?voice=male">male</a> <a href="./phoneme-test.html?voice=female">female</a></div>
    <svg style="width:0px;height:0px;" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <linearGradient id="ae" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(230,173,38)"/>
                <stop offset="50%" stop-color="rgb(230,173,38)"/>
                <stop offset="50%" stop-color="rgb(244,190,127)"/>
                <stop offset="100%" stop-color="rgb(244,190,127)"/>
            </linearGradient>
            <linearGradient id="aw" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#bbf"/>
                <stop offset="50%" stop-color="#bbf"/>
                <stop offset="50%" stop-color="#0f0"/>
                <stop offset="100%" stop-color="#0f0"/>
            </linearGradient>
            <linearGradient id="eh" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(120,63,4)"/>
                <stop offset="50%" stop-color="rgb(120,63,4)"/>
                <stop offset="50%" stop-color="rgb(244,190,127)"/>
                <stop offset="100%" stop-color="rgb(244,190,127)"/>
            </linearGradient>
            <linearGradient id="ih" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(152,199,102)"/>
                <stop offset="50%" stop-color="rgb(152,199,102)"/>
                <stop offset="50%" stop-color="rgb(255,242,89)"/>
                <stop offset="100%" stop-color="rgb(255,242,89)"/>
            </linearGradient>
            <linearGradient id="iy" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(1,153,124)"/>
                <stop offset="50%" stop-color="rgb(1,153,124)"/>
                <stop offset="50%" stop-color="rgb(120,63,4)"/>
                <stop offset="100%" stop-color="rgb(120,63,4)"/>
            </linearGradient>
            <linearGradient id="ow" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(221,76,54)"/>
                <stop offset="50%" stop-color="rgb(221,76,54)"/>
                <stop offset="50%" stop-color="rgb(137,104,158)"/>
                <stop offset="100%" stop-color="rgb(137,104,158)"/>
            </linearGradient>
            <linearGradient id="oy" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(221,76,54)"/>
                <stop offset="50%" stop-color="rgb(221,76,54)"/>
                <stop offset="50%" stop-color="rgb(1,153,124)"/>
                <stop offset="100%" stop-color="rgb(1,153,124)"/>
            </linearGradient>
            <linearGradient id="uh" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(244,190,127)"/>
                <stop offset="50%" stop-color="rgb(244,190,127)"/>
                <stop offset="50%" stop-color="rgb(255,242,89)"/>
                <stop offset="100%" stop-color="rgb(255,242,89)"/>
            </linearGradient>
            <linearGradient id="uw" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(137,104,158)"/>
                <stop offset="50%" stop-color="rgb(137,104,158)"/>
                <stop offset="50%" stop-color="rgb(0,153,206)"/>
                <stop offset="100%" stop-color="rgb(0,153,206)"/>
            </linearGradient>
            <linearGradient id="kw" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(165,166,164)"/>
                <stop offset="50%" stop-color="rgb(165,166,164)"/>
                <stop offset="50%" stop-color="rgb(110,120,172)"/>
                <stop offset="100%" stop-color="rgb(110,120,172)"/>
            </linearGradient>
            <linearGradient id="sh" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(0,68,51)"/>
                <stop offset="50%" stop-color="rgb(0,68,51)"/>
                <stop offset="50%" stop-color="rgb(244,190,131)"/>
                <stop offset="100%" stop-color="rgb(244,190,131)"/>
            </linearGradient>
            <linearGradient id="zh" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgb(221,76,54)"/>
                <stop offset="50%" stop-color="rgb(221,76,54)"/>
                <stop offset="50%" stop-color="rgb(225,124,167)"/>
                <stop offset="100%" stop-color="rgb(225,124,167)"/>
            </linearGradient>
        </defs>
    </svg>  
    <svg style="display:none;" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <circle id="circ" cx="100" cy="100" r="100"/>
    </svg>
    <template id="card-template">
        <div class="card">
            <svg viewBox="0 0 200 200" class="aa"><use xlink:href="#circ"/></svg>
            <span class="phoneme"></span>
        </div>
    </template>
    <div style="margin-top: 15vh;"><center><div id="container"></div></center></div>
    <script>
        var phonemes = ["AA", "AE", "AH", "AO", "AW", "AY", "CH", "EH", "ER", "EY", "F", "IH", "IU", "IY", "JH", "KW", "OW", "OY", "SH", "UH", "UL", "UW", "ZH"];
        var phonemeBuffers = {};
        var audioContext;
        var fieldset;

        function randomize(list) {
            let newList = list.slice();
            for (let i = 0; i < newList.length; ++i) {
                let j = Math.floor(Math.random() * newList.length);
                let k = Math.floor(Math.random() * newList.length);
                let tmp = newList[j];
                newList[j] = newList[k];
                newList[k] = tmp;
            }
            return newList;
        }

        function permutation(list, n) {
            let newList = randomize(list);
            newList = newList.slice(0, n);
            return newList;
        }

        function combination(list, n) {
            let newList = [];
            for (let i = 0; i < n; ++i)
                newList[i] = list[Math.floor(Math.random() * n)];
            return newList;
        }

        window.addEventListener('load', init, false);
        function init() {
            let url = new URL(window.location.href);
            let voice = (url.searchParams.get("voice") || "male") == "male" ? "arthur" : "monet";
            // Create audio context and preload sounds
            try {
                window.AudioContext = window.AudioContext||window.webkitAudioContext;
                audioContext = new AudioContext();
            }
            catch(e) {
                alert('Web Audio API is not supported in this browser');
            }
            for (phoneme of phonemes) {
                let request = new XMLHttpRequest();
                let url = "./phonemes/"+voice+"/"+phoneme+".wav";
                let phonemeCapture = phoneme;
                request.open('GET', url, true);
                request.responseType = 'arraybuffer';
                request.onload = function() {
                    var audioData = request.response;
                    console.log(phonemeCapture + " downloaded");
                    audioContext.decodeAudioData(audioData, function(buffer) {
                        phonemeBuffers[phonemeCapture] = buffer;
                        console.log(phonemeCapture + " buffered");
                    });
                };
                request.send();
            }
            // Create dom tree
            container = document.getElementById("container");
            let cardTemplate = document.getElementById('card-template');
            phonemes.forEach(phoneme => {
                let node = cardTemplate.content.cloneNode(true);
                let svg = node.querySelector("div.card svg");
                svg.setAttribute("class", phoneme);
                let card = node.querySelector("div.card");
                card.addEventListener('click', cardClicked, false);
                let text = node.querySelector("div.card span");
                text.innerText = phoneme;
                container.appendChild(node);
            });
        }
        function playPhoneme(phoneme, finished) {
            let source = audioContext.createBufferSource();
            let buffer = phonemeBuffers[phoneme];
            if (!buffer) {
                if (finished)
                    finished();
                return;
            }
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.onended = function(ev) {
                document.querySelector("fieldset").disabled = false;
                if (finished)
                    finished();
                console.log("finished playing " + phoneme);
            }
            console.log("trying to play " + phoneme);
            source.start(0);
            document.querySelector("fieldset").disabled = true;
        }
        function cardClicked(event) {
            let clickedCard = event.target;
            console.log(clickedCard);
            let clickedPhoneme = clickedCard.className.baseVal.toUpperCase();
            if (!clickedPhoneme) {
                clickedPhoneme = clickedCard.parentNode.className.baseVal.toUpperCase();
            }
            console.log("clicked on " + clickedPhoneme);
            playPhoneme(clickedPhoneme);
        }
    </script>
</body>
